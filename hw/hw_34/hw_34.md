# Работа с sqlite3 в Python

## Открытие соединения

Для работы с базой данных необходимо создать объект соединения:

```python
import sqlite3
conn = sqlite3.connect('my_database.db')
```

- Соединение (`Connection`) — основной объект для управления транзакциями и выполнением запросов.
- Соединение лучше создавать один раз на всё приложение или на сессию работы с БД.

## Курсор и соединение

- Курсор (`Cursor`) создаётся через метод `.cursor()` объекта соединения:

```python
cursor = conn.cursor()
```

- Курсор используется для выполнения SQL-запросов и получения результатов.
- Курсор можно создавать внутри функций, если он нужен только для одной операции.
- Соединение лучше передавать в функции как аргумент, а не создавать внутри каждой функции.

## Обычные и параметризованные запросы

- Обычные запросы:

```python
cursor.execute("SELECT * FROM table_name")
```

- Параметризованные запросы (безопасно для данных!):

```python
cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
```

- Используйте всегда параметризованные запросы для передачи переменных!

## Основные методы соединения и курсора

| Объект      | Метод                | Описание                                      |
|-------------|----------------------|-----------------------------------------------|
| Connection  | connect              | Открыть соединение с БД                       |
| Connection  | commit               | Зафиксировать транзакцию                      |
| Connection  | rollback             | Откатить транзакцию                           |
| Connection  | close                | Закрыть соединение                            |
| Connection  | cursor               | Получить курсор                               |
| Cursor      | execute              | Выполнить SQL-запрос                          |
| Cursor      | executemany          | Выполнить SQL-запрос для нескольких наборов   |
| Cursor      | executescript        | Выполнить несколько SQL-запросов из строки    |
| Cursor      | fetchone             | Получить одну строку результата               |
| Cursor      | fetchall             | Получить все строки результата                |
| Cursor      | close                | Закрыть курсор                                |

## Работа с транзакциями

### Вариант 1: Автоматическая транзакция

- Транзакция открывается автоматически при первом изменяющем запросе.
- Для сохранения изменений используйте `conn.commit()`, для отката — `conn.rollback()`.

```python
conn = sqlite3.connect('db.sqlite3')
cursor = conn.cursor()
cursor.execute("INSERT INTO ...")
conn.commit()  # обязательно для сохранения
```

### Вариант 2: Явное управление через BEGIN/COMMIT/ROLLBACK

- Можно явно открыть транзакцию:

```python
conn.execute("BEGIN")
try:
    cursor.execute("...")
    conn.commit()
except Exception:
    conn.rollback()
```

### Вариант 3: Контекстный менеджер

- Используйте соединение как контекстный менеджер:

```python
with sqlite3.connect('db.sqlite3') as conn:
    conn.execute("INSERT INTO ...")
# commit произойдёт автоматически, rollback — при ошибке
```

### Вариант 4: Через with для уже открытого соединения

```python
with conn:
    conn.execute("UPDATE ...")
# commit/rollback автоматически
```

## Рекомендации

- Соединение создавайте глобально или передавайте в функции.
- Курсор создавайте внутри функции, если он нужен только для одной операции.
- Всегда закрывайте соединение и курсор после работы.
- Используйте параметризованные запросы для безопасности.
- Для сложных операций используйте явное управление транзакциями или контекстный менеджер.

---

_Эти рекомендации основаны на официальной документации Python (Context7) и best practice 2025 года._
